pipeline {
    agent {
        label 'sha-ubuntu-node'
    }

    environment {
        IMAGE_NAME = "pac-demo:latest"
    }

    stages {
        stage('Setup Python Env') {
            steps {
                sh '''
                    python3 -m venv venv
                    ./venv/bin/pip install --upgrade pip
                    ./venv/bin/pip install --upgrade flask
                    ./venv/bin/pip install -r python_app/requirements.txt
                    ./venv/bin/pip install pytest 
                '''
            }
        }

        stage('Run Unit Tests') {
            steps {
                sh './venv/bin/python -m pytest --maxfail=1 --disable-warnings -q || echo "No tests yet"'
            }
        }

        stage('Trivy Security Scan') {
            steps {
                sh '''
                    if ! command -v trivy &> /dev/null; then
                    echo "ðŸ“¦ Installing Trivy..."
                    sudo apt-get update -y
                    sudo apt-get install -y wget apt-transport-https gnupg lsb-release
                    wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
                    echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
                    sudo apt-get update -y
                    sudo apt-get install -y trivy
                    fi

                    echo "ðŸ” Running Trivy scans..."
                    docker build -t ${IMAGE_NAME} .
                    trivy image --severity HIGH,CRITICAL --exit-code 1 ${IMAGE_NAME} || true
                    trivy fs --severity HIGH,CRITICAL --exit-code 1 . || true
                    docker image rmi ${IMAGE_NAME} -f
                '''
            }
        }
        stage('Cleanup Workspace') {
            steps {
                deleteDir()
                checkout scm
            }
        }

        stage('Policy-as-Code Check (OPA/Conftest)') {
    parallel {
        stage('Dockerfile Policy Check') {
            steps {
                sh '''#!/usr/bin/env bash
                set -euxo pipefail

                # Install conftest (idempotent)
                if ! command -v conftest >/dev/null 2>&1; then
                    wget -q "https://github.com/open-policy-agent/conftest/releases/download/v0.51.0/conftest_0.51.0_Linux_x86_64.tar.gz"
                    tar xzf conftest_0.51.0_Linux_x86_64.tar.gz
                    sudo mv conftest /usr/local/bin/
                fi

                echo "ðŸ”Ž Running Dockerfile policy checks..."
                set +e
                conftest test ${WORKSPACE}/Dockerfile --parser dockerfile -p ${WORKSPACE}/policy/docker > docker_policy_result.txt 2>&1
                docker_exit=$?
                set -e
                echo "Dockerfile Conftest Exit Code: $docker_exit"
                exit $docker_exit
                '''
            }
        }

        stage('Terraform Policy Check') {
            steps {
                sh '''#!/usr/bin/env bash
                set -euxo pipefail

                if ! command -v conftest >/dev/null 2>&1; then
                    wget -q "https://github.com/open-policy-agent/conftest/releases/download/v0.51.0/conftest_0.51.0_Linux_x86_64.tar.gz"
                    tar xzf conftest_0.51.0_Linux_x86_64.tar.gz
                    sudo mv conftest /usr/local/bin/
                fi

                echo "ðŸ”Ž Running Terraform policy checks..."
                set +e
                conftest verify -p ${WORKSPACE}/policy/terraform/ > terraform_verify.txt 2>&1
                conftest test ${WORKSPACE}/terraform/ --parser hcl2 -p ${WORKSPACE}/policy/terraform/ > terraform_policy_result.txt 2>&1
                terraform_exit=$?
                set -e
                echo "Terraform Conftest Exit Code: $terraform_exit"
                exit $terraform_exit
                '''
            }
        }
        }
    }

        stage('Build and Push Image') {
            when { expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' } }
            steps {
                sh '''
                    echo "âœ… All checks passed. Proceeding with image build."
                    #docker build -t ${IMAGE_NAME} .
                '''
            }
        }
    }
}
